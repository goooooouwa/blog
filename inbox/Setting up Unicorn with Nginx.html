<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 6.13 (455674)"/><meta name="keywords" content="nginx, unicorn"/><meta name="author" content="Greg Xu"/><meta name="created" content="2013-09-22 03:50:05 +0000"/><meta name="latitude" content="30.52221716666666"/><meta name="longitude" content="114.3618605166666"/><meta name="source" content="web.clip"/><meta name="source-url" content="http://sirupsen.com/setting-up-unicorn-with-nginx/"/><meta name="updated" content="2013-09-22 13:28:46 +0000"/><title>Setting up Unicorn with Nginx</title></head><body><div style="position: relative; max-width: 580px;">
<div style="font-size: 16px;">
<div style="font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline;">
<div style="font-family: 'Open sans', sans-serif; font-size: 18px; font-style: normal; font-variant: normal; font-weight: normal; line-height: 21px; vertical-align: baseline; background-color: #ffffff; color: #444444; -webkit-font-smoothing: antialiased;">
<div style="font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline;">
<div style="font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline;">
<div style="margin: 0px; padding: 0px; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline; float: left; display: inline; margin-left: 10px; margin-right: 10px; width: 580px;">
<h1 style="margin: 0px; padding: 0px; border: 0px; font-family: 'Droid Serif', serif; font-size: 2em; font-style: inherit; font-variant: inherit; font-weight: bold; line-height: 40px; vertical-align: baseline; color: #423f37; margin-bottom: 20px;"><span style="font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; color: #444444; line-height: 28px;">set up </span><a shape="rect" style="font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; margin: 0px; padding: 0px; border: 0px; vertical-align: baseline; color: #333333; outline: 0px;" href="http://nginx.org/">nginx</a><span style="font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; color: #444444; line-height: 28px;"> in front of Unicorn</span></h1>
<h2 style="margin: 0px; padding: 0px; border: 0px; font-family: 'Droid Serif', serif; font-size: 1.5em; font-style: inherit; font-variant: inherit; font-weight: normal; line-height: 1.3em; vertical-align: baseline; color: #423f37; margin-bottom: 10px; padding-bottom: 0.4em;">nginx</h2>
<div><ol><li><span style="font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; line-height: inherit;">grab</span> <a shape="rect" style="font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; line-height: inherit; margin: 0px; padding: 0px; border: 0px; vertical-align: baseline; color: #333333; outline: 0px;" href="http://github.com/defunkt/unicorn/blob/master/examples/nginx.conf">the <code style="margin: 0px; padding: 0px; border: 0px; font-family: Monaco, Consolas, monospace; font-size: inherit; font-style: inherit; font-variant: inherit; line-height: inherit; vertical-align: baseline; text-decoration: none;">nginx.conf</code> exampleconfiguration shipped with Unicorn</a><span style="font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; line-height: inherit;">, </span></li><li><span style="font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; line-height: inherit;">store at </span><code style="font-size: inherit; font-style: inherit; font-variant: inherit; line-height: inherit; margin: 0px; padding: 0px; border: 0px; font-family: Monaco, Consolas, monospace; vertical-align: baseline;">/etc/nginx/nginx.conf</code></li><li><span style="font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; line-height: inherit;">tweak it to your likings, read the comments–they’re quite good.</span></li></ol></div>
<div><br clear="none"/></div>
<h2 style="margin: 0px; padding: 0px; border: 0px; font-family: 'Droid Serif', serif; font-size: 1.5em; font-style: inherit; font-variant: inherit; font-weight: normal; line-height: 1.3em; vertical-align: baseline; color: #423f37; margin-bottom: 10px; padding-bottom: 0.4em;">Unicorn</h2>
<p style="margin: 0px 0px 20px; padding: 0px; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: 28px; vertical-align: baseline;">1. new a rails app</p>
<div style="margin: 0px; padding: 0px; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline; background-color: #ffffff;">
<pre style="margin: 0px 0px 20px 20px; padding: 0px; border: 0px; font-family: inherit; font-size: 80%; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline; white-space: pre-wrap; word-wrap: break-word; text-decoration: none;" xml:space="preserve"><code style="margin: 0px; padding: 0px; border: 0px; font-family: Monaco, Consolas, monospace; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline; text-decoration: none;"><span style="margin: 0px; padding: 0px; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline; color: #008080;">$ </span><span style="margin: 0px; padding: 0px; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline; color: #0086b3;">cd</span> /var/www<span style="margin: 0px; padding: 0px; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline; color: #008080;">$ </span>rails new unicorn</code>
</pre>
</div>
<p style="margin: 0px 0px 20px; padding: 0px; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: 28px; vertical-align: baseline;">2. fetch a Unicorn config file</p>
<div style="margin: 0px; padding: 0px; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline; background-color: #ffffff;">
<pre style="margin: 0px 0px 20px 20px; padding: 0px; border: 0px; font-family: inherit; font-size: 80%; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline; white-space: pre-wrap; word-wrap: break-word; text-decoration: none;" xml:space="preserve"><code style="margin: 0px; padding: 0px; border: 0px; font-family: Monaco, Consolas, monospace; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline; text-decoration: none;"><span style="margin: 0px; padding: 0px; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline; color: #008080;">$ </span>curl -o config/unicorn.rb https://raw.github.com/defunkt/unicorn/master/examples/unicorn.conf.rb</code>
</pre>
</div>
<p style="margin: 0px 0px 20px; padding: 0px; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: 28px; vertical-align: baseline;">3. tweak a few things to set the right paths:</p>
<div style="margin: 0px; padding: 0px; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline; background-color: #ffffff;">
<pre style="margin: 0px 0px 20px 20px; padding: 0px; border: 0px; font-family: inherit; font-size: 80%; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline; white-space: pre-wrap; word-wrap: break-word; text-decoration: none;" xml:space="preserve"><code style="margin: 0px; padding: 0px; border: 0px; font-family: Monaco, Consolas, monospace; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline; text-decoration: none;"><span style="margin: 0px; padding: 0px; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline; color: #008080;">APP_PATH</span> <span style="margin: 0px; padding: 0px; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: bold; line-height: inherit; vertical-align: baseline;">=</span> <span style="margin: 0px; padding: 0px; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline; color: #dd1144;">"/var/www/unicorn"</span><span style="margin: 0px; padding: 0px; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline;">working_directory</span> <span style="margin: 0px; padding: 0px; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline; color: #008080;">APP_PATH</span><span style="margin: 0px; padding: 0px; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline;">stderr_path</span> <span style="margin: 0px; padding: 0px; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline; color: #008080;">APP_PATH</span> <span style="margin: 0px; padding: 0px; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: bold; line-height: inherit; vertical-align: baseline;">+</span> <span style="margin: 0px; padding: 0px; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline; color: #dd1144;">"/log/unicorn.stderr.log"</span><span style="margin: 0px; padding: 0px; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline;">stdout_path</span> <span style="margin: 0px; padding: 0px; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline; color: #008080;">APP_PATH</span> <span style="margin: 0px; padding: 0px; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: bold; line-height: inherit; vertical-align: baseline;">+</span> <span style="margin: 0px; padding: 0px; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline; color: #dd1144;">"/log/unicorn.stderr.log"</span><span style="margin: 0px; padding: 0px; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline;">pid</span> <span style="margin: 0px; padding: 0px; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline; color: #008080;">APP_PATH</span> <span style="margin: 0px; padding: 0px; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: bold; line-height: inherit; vertical-align: baseline;">+</span> <span style="margin: 0px; padding: 0px; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline; color: #dd1144;">"/tmp/pid/unicorn.pid"</span></code>
</pre>
</div>
<p style="margin: 0px 0px 20px; padding: 0px; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: 28px; vertical-align: baseline;">Then Unicorn is configured!</p>
<h2 style="margin: 0px; padding: 0px; border: 0px; font-family: 'Droid Serif', serif; font-size: 1.5em; font-style: inherit; font-variant: inherit; font-weight: normal; line-height: 1.3em; vertical-align: baseline; color: #423f37; margin-bottom: 10px; padding-bottom: 0.4em;">Rainbow magic</h2>
<p style="margin: 0px 0px 20px; padding: 0px; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: 28px; vertical-align: baseline;">Start the nginx deamon, this depends on your OS. Then start Unicorn:</p>
<div style="margin: 0px; padding: 0px; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline; background-color: #ffffff;">
<pre style="margin: 0px 0px 20px 20px; padding: 0px; border: 0px; font-family: inherit; font-size: 80%; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline; white-space: pre-wrap; word-wrap: break-word; text-decoration: none;" xml:space="preserve"><code style="margin: 0px; padding: 0px; border: 0px; font-family: Monaco, Consolas, monospace; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline; text-decoration: none;"><span style="margin: 0px; padding: 0px; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline; color: #008080;">$ </span>unicorn_rails -c /var/www/unicorn/config/unicorn.rb -D<span style="-evernote-last-insertion-point: true;"/></code>
</pre>
</div>
<p style="margin: 0px 0px 20px; padding: 0px; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: 28px; vertical-align: baseline;">That’s it! Visiting <a shape="rect" style="margin: 0px; padding: 0px; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline; color: #333333; text-decoration: underline; outline: 0px;" href="http://localhost/">localhost</a> should take you to the Rails default page.</p>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div><br clear="none"/></div>
<table width="100%" border="0" bgcolor="#D4DDE5"><tr><td colspan="1" rowspan="1">
<h1>details of how to config nginx and unicorn</h1>
</td></tr></table>
<div><strong>Commands</strong></div>
<div>stop nginx:
<div>$ sudo nginx -s stop</div>
<div><br clear="none"/></div>
<div>start nginx with configuration file:</div>
<div>$ sudo nginx -c path/to/config</div>
<div><br clear="none"/></div>
<div>start unicorn with configuration in production environment:</div>
<div>$ bundle exec unicorn -c path/to/config -E production -p port </div>
<div><br clear="none"/></div>
<div>watch all log files under log folder:</div>
<div>$ tail -f log/*.log</div>
<div><br clear="none"/></div>
<div><br clear="none"/></div>
<div><strong>Configurations</strong></div>
<div>Basic configuration items:</div>
<div>
<ul><li>root path</li><li>log path</li><li>socket path</li><li>pid path</li><li>listen port</li></ul>
</div>
<div><br clear="none"/></div>
<div><span style="-evernote-last-insertion-point: true;"/></div>
<div><strong>Examples:</strong></div>
<div>//an example unicorn config file:</div>
<span style="font-size: 11px; font-family: Menlo;">upstream unicorn {<br clear="none"/>   server unix:/Users/greg/projects/timeline/tmp/sockets/unicorn.timeline.sock fail_timeout=0;<br clear="none"/> }<br clear="none"/> <br clear="none"/> server {<br clear="none"/>   # listen 80 default deferred; # for Linux<br clear="none"/>   # listen 80 default accept_filter=httpready; # for FreeBSD<br clear="none"/>   listen 80 default;<br clear="none"/>  <br clear="none"/>   server_name <a shape="rect" href="http://timeline.local">timeline.local</a>;<br clear="none"/>  <br clear="none"/>   root /Users/greg/projects/timeline/public;<br clear="none"/>   try_files $uri/index.html $uri @unicorn;<br clear="none"/>   location @unicorn {<br clear="none"/>     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;<br clear="none"/>     proxy_set_header Host $http_host;<br clear="none"/>     proxy_redirect off;<br clear="none"/>     proxy_pass <a shape="rect" href="http://unicorn">http://unicorn</a>;<br clear="none"/>     access_log /usr/local/var/log/nginx/access.log;<br clear="none"/>     error_log /usr/local/var/log/nginx/error.log;<br clear="none"/>   }<br clear="none"/>  <br clear="none"/>   error_page 500 502 503 504 /500.html;<br clear="none"/>   client_max_body_size 100M;<br clear="none"/>   keepalive_timeout 10;<br clear="none"/> }</span></div>
<div><span style="font-family: Menlo;"><span style="font-size: 11px;"><br clear="none"/></span></span>
<div><br clear="none"/></div>
<div>//an example unicorn config file:</div>
<span style="font-size: 11px; font-family: Menlo; color: #008400;"># Sample verbose configuration file for Unicorn (not Rack)</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/></span><span style="font-size: 11px; font-family: Menlo; color: #008400;">#</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/></span><span style="font-size: 11px; font-family: Menlo; color: #008400;"># This configuration file documents many features of Unicorn</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/></span><span style="font-size: 11px; font-family: Menlo; color: #008400;"># that may not be needed for some applications. See</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/></span><span style="font-size: 11px; font-family: Menlo; color: #008400;"># <a shape="rect" href="http://unicorn.bogomips.org/examples/unicorn.conf.minimal.rb"><span style="color: #1337ff;">http://unicorn.bogomips.org/examples/unicorn.conf.minimal.rb</span></a></span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/></span><span style="font-size: 11px; font-family: Menlo; color: #008400;"># for a much simpler configuration file.</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/></span><span style="font-size: 11px; font-family: Menlo; color: #008400;">#</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/></span><span style="font-size: 11px; font-family: Menlo; color: #008400;"># See <a shape="rect" href="http://unicorn.bogomips.org/Unicorn/Configurator.html"><span style="color: #1337ff;">http://unicorn.bogomips.org/Unicorn/Configurator.html</span></a> for complete</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/></span><span style="font-size: 11px; font-family: Menlo; color: #008400;"># documentation.</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/> <br clear="none"/></span><span style="font-size: 11px; font-family: Menlo; color: #008400;"># Use at least one worker per core if you're on a dedicated server,</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/></span><span style="font-size: 11px; font-family: Menlo; color: #008400;"># more will usually help for _short_ waits on databases/caches.</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/> worker_processes</span> <span style="font-size: 11px; font-family: Menlo; color: #272ad8;">4</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/> <br clear="none"/></span><span style="font-size: 11px; font-family: Menlo; color: #008400;"># Since Unicorn is never exposed to outside clients, it does not need to</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/></span><span style="font-size: 11px; font-family: Menlo; color: #008400;"># run on the standard HTTP port (80), there is no reason to start Unicorn</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/></span><span style="font-size: 11px; font-family: Menlo; color: #008400;"># as root unless it's from system init scripts.</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/></span><span style="font-size: 11px; font-family: Menlo; color: #008400;"># If running the master process as root and the workers as an unprivileged</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/></span><span style="font-size: 11px; font-family: Menlo; color: #008400;"># user, do this to switch euid/egid in the workers (also chowns logs):</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/></span><span style="font-size: 11px; font-family: Menlo; color: #008400;"># user "unprivileged_user", "unprivileged_group"</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/> <br clear="none"/></span><span style="font-size: 11px; font-family: Menlo; color: #008400;"># Help ensure your application will always spawn in the symlinked</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/></span><span style="font-size: 11px; font-family: Menlo; color: #008400;"># "current" directory that Capistrano sets up.</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/> APP_PATH =</span> <span style="font-size: 11px; font-family: Menlo; color: #d12f1b;">"/Users/greg/projects/timeline"</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/> working_directory APP_PATH</span> <span style="font-size: 11px; font-family: Menlo; color: #008400;"># available in 0.94.0+</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/> <br clear="none"/></span><span style="font-size: 11px; font-family: Menlo; color: #008400;"># listen on both a Unix domain socket and a TCP port,</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/></span><span style="font-size: 11px; font-family: Menlo; color: #008400;"># we use a shorter backlog for quicker failover when busy</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/> listen APP_PATH +</span> <span style="font-size: 11px; font-family: Menlo; color: #d12f1b;">"/tmp/sockets/unicorn.timeline.sock"</span><span style="font-size: 11px; font-family: Menlo;">, :backlog =&gt;</span> <span style="font-size: 11px; font-family: Menlo; color: #272ad8;">64</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/> listen</span> <span style="font-size: 11px; font-family: Menlo; color: #272ad8;">9000</span><span style="font-size: 11px; font-family: Menlo;">, :tcp_nopush =&gt;</span> <span style="font-size: 11px; font-family: Menlo; color: #bb2ca2;">true</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/> <br clear="none"/></span><span style="font-size: 11px; font-family: Menlo; color: #008400;"># nuke workers after 30 seconds instead of 60 seconds (the default)</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/> timeout</span> <span style="font-size: 11px; font-family: Menlo; color: #272ad8;">30</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/> <br clear="none"/></span><span style="font-size: 11px; font-family: Menlo; color: #008400;"># feel free to point this anywhere accessible on the filesystem</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/> pid pid APP_PATH +</span> <span style="font-size: 11px; font-family: Menlo; color: #d12f1b;">"/tmp/pids/unicorn.pid"</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/> <br clear="none"/></span><span style="font-size: 11px; font-family: Menlo; color: #008400;"># By default, the Unicorn logger will write to stderr.</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/></span><span style="font-size: 11px; font-family: Menlo; color: #008400;"># Additionally, ome applications/frameworks log to stderr or stdout,</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/></span><span style="font-size: 11px; font-family: Menlo; color: #008400;"># so prevent them from going to /dev/null when daemonized here:</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/> stderr_path APP_PATH +</span> <span style="font-size: 11px; font-family: Menlo; color: #d12f1b;">"/log/unicorn.stderr.log"</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/> stdout_path APP_PATH +</span> <span style="font-size: 11px; font-family: Menlo; color: #d12f1b;">"/log/unicorn.stderr.log"</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/> <br clear="none"/></span><span style="font-size: 11px; font-family: Menlo; color: #008400;"># combine Ruby 2.0.0dev or REE with "preload_app true" for memory savings</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/></span><span style="font-size: 11px; font-family: Menlo; color: #008400;"># <a shape="rect" href="http://rubyenterpriseedition.com/faq.html#adapt_apps_for_cow"><span style="color: #1337ff;">http://rubyenterpriseedition.com/faq.html#adapt_apps_for_cow</span></a></span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/> preload_app</span> <span style="font-size: 11px; font-family: Menlo; color: #bb2ca2;">true</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/> GC.respond_to?(:copy_on_write_friendly=)</span> <span style="font-size: 11px; font-family: Menlo; color: #bb2ca2;">and</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/>   GC.copy_on_write_friendly =</span> <span style="font-size: 11px; font-family: Menlo; color: #bb2ca2;">true</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/> <br clear="none"/></span><span style="font-size: 11px; font-family: Menlo; color: #008400;"># Enable this flag to have unicorn test client connections by writing the</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/></span><span style="font-size: 11px; font-family: Menlo; color: #008400;"># beginning of the HTTP headers before calling the application.  This</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/></span><span style="font-size: 11px; font-family: Menlo; color: #008400;"># prevents calling the application for connections that have disconnected</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/></span><span style="font-size: 11px; font-family: Menlo; color: #008400;"># while queued.  This is only guaranteed to detect clients on the same</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/></span><span style="font-size: 11px; font-family: Menlo; color: #008400;"># host unicorn runs on, and unlikely to detect disconnects even on a</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/></span><span style="font-size: 11px; font-family: Menlo; color: #008400;"># fast LAN.</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/> check_client_connection</span> <span style="font-size: 11px; font-family: Menlo; color: #bb2ca2;">false</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/> <br clear="none"/> before_fork</span> <span style="font-size: 11px; font-family: Menlo; color: #bb2ca2;">do</span> <span style="font-size: 11px; font-family: Menlo;">|server, worker|<br clear="none"/>  </span> <span style="font-size: 11px; font-family: Menlo; color: #008400;"># the following is highly recomended for Rails + "preload_app true"</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/>  </span> <span style="font-size: 11px; font-family: Menlo; color: #008400;"># as there's no need for the master process to hold a connection</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/>  </span> <span style="font-size: 11px; font-family: Menlo; color: #bb2ca2;">defined?</span><span style="font-size: 11px; font-family: Menlo;">(ActiveRecord::Base)</span> <span style="font-size: 11px; font-family: Menlo; color: #bb2ca2;">and</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/>     ActiveRecord::Base.connection.disconnect!<br clear="none"/> <br clear="none"/>  </span> <span style="font-size: 11px; font-family: Menlo; color: #008400;"># The following is only recommended for memory/DB-constrained</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/>  </span> <span style="font-size: 11px; font-family: Menlo; color: #008400;"># installations.  It is not needed if your system can house</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/>  </span> <span style="font-size: 11px; font-family: Menlo; color: #008400;"># twice as many worker_processes as you have configured.</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/>  </span> <span style="font-size: 11px; font-family: Menlo; color: #008400;">#</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/>  </span> <span style="font-size: 11px; font-family: Menlo; color: #008400;"># # This allows a new master process to incrementally</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/>  </span> <span style="font-size: 11px; font-family: Menlo; color: #008400;"># # phase out the old master process with SIGTTOU to avoid a</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/>  </span> <span style="font-size: 11px; font-family: Menlo; color: #008400;"># # thundering herd (especially in the "preload_app false" case)</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/>  </span> <span style="font-size: 11px; font-family: Menlo; color: #008400;"># # when doing a transparent upgrade.  The last worker spawned</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/>  </span> <span style="font-size: 11px; font-family: Menlo; color: #008400;"># # will then kill off the old master process with a SIGQUIT.</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/>  </span> <span style="font-size: 11px; font-family: Menlo; color: #008400;"># old_pid = "#{server.config[:pid]}.oldbin"</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/>  </span> <span style="font-size: 11px; font-family: Menlo; color: #008400;"># if old_pid != server.pid</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/>  </span> <span style="font-size: 11px; font-family: Menlo; color: #008400;">#   begin</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/>  </span> <span style="font-size: 11px; font-family: Menlo; color: #008400;">#     sig = (worker.nr + 1) &gt;= server.worker_processes ? :QUIT : :TTOU</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/>  </span> <span style="font-size: 11px; font-family: Menlo; color: #008400;">#     Process.kill(sig, File.read(old_pid).to_i)</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/>  </span> <span style="font-size: 11px; font-family: Menlo; color: #008400;">#   rescue Errno::ENOENT, Errno::ESRCH</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/>  </span> <span style="font-size: 11px; font-family: Menlo; color: #008400;">#   end</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/>  </span> <span style="font-size: 11px; font-family: Menlo; color: #008400;"># end</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/>  </span> <span style="font-size: 11px; font-family: Menlo; color: #008400;">#</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/>  </span> <span style="font-size: 11px; font-family: Menlo; color: #008400;"># Throttle the master from forking too quickly by sleeping.  Due</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/>  </span> <span style="font-size: 11px; font-family: Menlo; color: #008400;"># to the implementation of standard Unix signal handlers, this</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/>  </span> <span style="font-size: 11px; font-family: Menlo; color: #008400;"># helps (but does not completely) prevent identical, repeated signals</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/>  </span> <span style="font-size: 11px; font-family: Menlo; color: #008400;"># from being lost when the receiving process is busy.</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/>  </span> <span style="font-size: 11px; font-family: Menlo; color: #008400;"># sleep 1</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/></span><span style="font-size: 11px; font-family: Menlo; color: #bb2ca2;">end</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/> <br clear="none"/> after_fork</span> <span style="font-size: 11px; font-family: Menlo; color: #bb2ca2;">do</span> <span style="font-size: 11px; font-family: Menlo;">|server, worker|<br clear="none"/>  </span> <span style="font-size: 11px; font-family: Menlo; color: #008400;"># per-process listener ports for debugging/admin/migrations</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/>  </span> <span style="font-size: 11px; font-family: Menlo; color: #008400;"># addr = "127.0.0.1:#{9293 + <a shape="rect" href="http://worker.nr">worker.nr</a>}"</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/>  </span> <span style="font-size: 11px; font-family: Menlo; color: #008400;"># server.listen(addr, :tries =&gt; -1, :delay =&gt; 5, :tcp_nopush =&gt; true)</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/> <br clear="none"/>  </span> <span style="font-size: 11px; font-family: Menlo; color: #008400;"># the following is *required* for Rails + "preload_app true",</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/>  </span> <span style="font-size: 11px; font-family: Menlo; color: #bb2ca2;">defined?</span><span style="font-size: 11px; font-family: Menlo;">(ActiveRecord::Base)</span> <span style="font-size: 11px; font-family: Menlo; color: #bb2ca2;">and</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/>     ActiveRecord::Base.establish_connection<br clear="none"/> <br clear="none"/>  </span> <span style="font-size: 11px; font-family: Menlo; color: #008400;"># if preload_app is true, then you may also want to check and</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/>  </span> <span style="font-size: 11px; font-family: Menlo; color: #008400;"># restart any other shared sockets/descriptors such as Memcached,</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/>  </span> <span style="font-size: 11px; font-family: Menlo; color: #008400;"># and Redis.  TokyoCabinet file handles are safe to reuse</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/>  </span> <span style="font-size: 11px; font-family: Menlo; color: #008400;"># between any number of forked children (assuming your kernel</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/>  </span> <span style="font-size: 11px; font-family: Menlo; color: #008400;"># correctly implements pread()/pwrite() system calls)</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/></span><span style="font-size: 11px; font-family: Menlo; color: #bb2ca2;">end</span><span style="font-size: 11px; font-family: Menlo;"><br clear="none"/></span>
<div><br clear="none"/></div>
</div></body></html>