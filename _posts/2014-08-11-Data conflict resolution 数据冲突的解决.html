---
layout: post
title: 'Data conflict resolution 数据冲突的解决'
---
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 6.13 (455674)"/><meta name="altitude" content="39.5125846862793"/><meta name="author" content="Greg Xu"/><meta name="created" content="2014-08-11 08:03:02 +0000"/><meta name="latitude" content="30.52221829559866"/><meta name="longitude" content="114.3619375931439"/><meta name="updated" content="2014-11-07 03:35:24 +0000"/><title>Data conflict resolution 数据冲突的解决</title></head><body style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;">
当不止一个master向同一个database写数据时（比如，应用程序离线状态对本地数据做的修改，待在线时与中心数据同步时），就可能产生数据冲突。这时程序需要采取合适的合并策略来解决冲突。常见的合并策略有：<a href="https://developer.apple.com/library/ios/documentation/CoreData/Reference/NSMergePolicy_Class/Reference/Reference.html%23//apple_ref/doc/c_ref/NSErrorMergePolicy" style="color: rgb(51, 102, 204); text-decoration: none; font-family: Courier, Consolas, monospace; font-size: 13px; background-color: rgb(255, 255, 255);">NSErrorMergePolicy</a>， <code style="font-size: 13px; font-family: Courier, Consolas, monospace; color: rgb(102, 102, 102); background-color: rgb(255, 255, 255);"><a href="https://developer.apple.com/library/ios/documentation/CoreData/Reference/NSMergePolicy_Class/Reference/Reference.html#//apple_ref/doc/c_ref/NSMergeByPropertyStoreTrumpMergePolicy" style="color: rgb(51, 102, 204); text-decoration: none;">NSMergeByPropertyStoreTrumpMergePolicy</a></code><span style="font-family: 'Lucida Grande', 'Lucida Sans Unicode', Helvetica, Arial, Verdana, sans-serif; font-size: 13px; background-color: rgb(255, 255, 255);">, </span><code style="font-size: 13px; font-family: Courier, Consolas, monospace; color: rgb(102, 102, 102); background-color: rgb(255, 255, 255);"><a href="https://developer.apple.com/library/ios/documentation/CoreData/Reference/NSMergePolicy_Class/Reference/Reference.html#//apple_ref/doc/c_ref/NSMergeByPropertyObjectTrumpMergePolicy" style="color: rgb(51, 102, 204); text-decoration: none;">NSMergeByPropertyObjectTrumpMergePolicy</a></code><span style="font-family: 'Lucida Grande', 'Lucida Sans Unicode', Helvetica, Arial, Verdana, sans-serif; font-size: 13px; background-color: rgb(255, 255, 255);">,</span> <code style="font-size: 13px; font-family: Courier, Consolas, monospace; color: rgb(102, 102, 102); background-color: rgb(255, 255, 255);"><a href="https://developer.apple.com/library/ios/documentation/CoreData/Reference/NSMergePolicy_Class/Reference/Reference.html#//apple_ref/doc/c_ref/NSOverwriteMergePolicy" style="color: rgb(51, 102, 204); text-decoration: none;">NSOverwriteMergePolicy</a>，<span style="color: rgb(0, 0, 0); font-family: 'Lucida Grande', 'Lucida Sans Unicode', Helvetica, Arial, Verdana, sans-serif;">and </span><a href="https://developer.apple.com/library/ios/documentation/CoreData/Reference/NSMergePolicy_Class/Reference/Reference.html%23//apple_ref/doc/c_ref/NSRollbackMergePolicy" style="color: rgb(51, 102, 204); text-decoration: none;">NSRollbackMergePolicy</a>.</code>
<div>
<div><br/></div>
<div>The <code style="font-family: Courier, Consolas, monospace; color: rgb(102, 102, 102);"><a href="https://developer.apple.com/library/ios/documentation/CoreData/Reference/NSMergePolicy_Class/Reference/Reference.html#//apple_ref/doc/c_ref/NSErrorMergePolicy" style="color: rgb(51, 102, 204); text-decoration: none;">NSErrorMergePolicy</a></code> is the only policy that generates an error. Other policies—<code style="font-family: Courier, Consolas, monospace; color: rgb(102, 102, 102);"><a href="https://developer.apple.com/library/ios/documentation/CoreData/Reference/NSMergePolicy_Class/Reference/Reference.html#//apple_ref/doc/c_ref/NSMergeByPropertyStoreTrumpMergePolicy" style="color: rgb(51, 102, 204); text-decoration: none;">NSMergeByPropertyStoreTrumpMergePolicy</a></code>, <code style="font-family: Courier, Consolas, monospace; color: rgb(102, 102, 102);"><a href="https://developer.apple.com/library/ios/documentation/CoreData/Reference/NSMergePolicy_Class/Reference/Reference.html#//apple_ref/doc/c_ref/NSMergeByPropertyObjectTrumpMergePolicy" style="color: rgb(51, 102, 204); text-decoration: none;">NSMergeByPropertyObjectTrumpMergePolicy</a></code>, and<code style="font-family: Courier, Consolas, monospace; color: rgb(102, 102, 102);"><a href="https://developer.apple.com/library/ios/documentation/CoreData/Reference/NSMergePolicy_Class/Reference/Reference.html#//apple_ref/doc/c_ref/NSOverwriteMergePolicy" style="color: rgb(51, 102, 204); text-decoration: none;">NSOverwriteMergePolicy</a></code>—allow the save to proceed by merging the state of the edited objects with the state of the objects in the store in different ways. The<code style="font-family: Courier, Consolas, monospace; color: rgb(102, 102, 102);"><a href="https://developer.apple.com/library/ios/documentation/CoreData/Reference/NSMergePolicy_Class/Reference/Reference.html#//apple_ref/doc/c_ref/NSRollbackMergePolicy" style="color: rgb(51, 102, 204); text-decoration: none;">NSRollbackMergePolicy</a></code> discards in-memory state changes for objects in conflict and uses the persistent store’s version of the objects’ state.</div>
<div><br/></div>
<div>
<h3 style="font-size: 19px; font-weight: 400; font-family: 'Lucida Grande', 'Lucida Sans Unicode', Helvetica, Arial, Verdana, sans-serif; background-color: rgb(255, 255, 255);">Merge Policies</h3>
<p style="font-size: 13px; font-family: 'Lucida Grande', 'Lucida Sans Unicode', Helvetica, Arial, Verdana, sans-serif; background-color: rgb(255, 255, 255);">Merge policy singleton objects that define standard ways to handle conflicts during a save operation.</p>
<pre style="font-size: 13px; font-family: Courier, Consolas, monospace; color: rgb(102, 102, 102); background-color: rgb(255, 255, 255);">
id NSErrorMergePolicy;
id NSMergeByPropertyStoreTrumpMergePolicy;
id NSMergeByPropertyObjectTrumpMergePolicy;
id NSOverwriteMergePolicy;
id NSRollbackMergePolicy;
</pre>
<h5 style="padding: 0px; font-size: 13px; font-family: 'Lucida Grande', 'Lucida Sans Unicode', Helvetica, Arial, Verdana, sans-serif; background-color: rgb(255, 255, 255);">Constants</h5>
<dl style="font-family: 'Lucida Grande', 'Lucida Sans Unicode', Helvetica, Arial, Verdana, sans-serif; font-size: 13px; background-color: rgb(255, 255, 255);">
<dd><a name="//apple_ref/c/data/NSErrorMergePolicy" title="NSErrorMergePolicy" style="color: rgb(51, 102, 204);"/><a name="//apple_ref/doc/c_ref/NSErrorMergePolicy" title="NSErrorMergePolicy" style="color: rgb(51, 102, 204);"/><a name="//apple_ref/doc/uid/TP40010614-CH1-SW25" title="NSErrorMergePolicy" style="color: rgb(51, 102, 204);"/><a name="//apple_ref/doc/uid/TP40010614-CH1-DontLinkElementID_11" style="color: rgb(51, 102, 204);"/></dd>
<dt style="clear: both;"><code style="font-family: Courier, Consolas, monospace; color: rgb(102, 102, 102);">NSErrorMergePolicy</code></dt>
<dd>
<p>This policy causes a save to fail if there are any merge conflicts.</p>
<p>This is the default policy for all managed object contexts.</p>
<p>In the case of failure, the save method returns with an error with a userInfo dictionary that contains the object IDs of the objects that had conflicts (<code style="font-family: Courier, Consolas, monospace; color: rgb(102, 102, 102);"><a href="https://developer.apple.com/library/ios/documentation/Cocoa/Reference/CoreDataFramework/Classes/NSManagedObjectContext_Class/NSManagedObjectContext.html%23//apple_ref/c/data/NSInsertedObjectsKey" target="_self" style="color: rgb(51, 102, 204); text-decoration: none;">NSInsertedObjectsKey</a></code>, <code style="font-family: Courier, Consolas, monospace; color: rgb(102, 102, 102);"><a href="https://developer.apple.com/library/ios/documentation/Cocoa/Reference/CoreDataFramework/Classes/NSManagedObjectContext_Class/NSManagedObjectContext.html%23//apple_ref/c/data/NSUpdatedObjectsKey" target="_self" style="color: rgb(51, 102, 204); text-decoration: none;">NSUpdatedObjectsKey</a></code>).</p>
<p>Available in iOS 3.0 and later.</p>
<p>Declared in <code style="font-family: Courier, Consolas, monospace; color: rgb(102, 102, 102);">NSMergePolicy.h</code>.</p>
</dd>
<dd><a name="//apple_ref/c/data/NSMergeByPropertyStoreTrumpMergePolicy" title="NSMergeByPropertyStoreTrumpMergePolicy" style="color: rgb(51, 102, 204);"/><a name="//apple_ref/doc/c_ref/NSMergeByPropertyStoreTrumpMergePolicy" title="NSMergeByPropertyStoreTrumpMergePolicy" style="color: rgb(51, 102, 204);"/><a name="//apple_ref/doc/uid/TP40010614-CH1-SW26" title="NSMergeByPropertyStoreTrumpMergePolicy" style="color: rgb(51, 102, 204);"/><a name="//apple_ref/doc/uid/TP40010614-CH1-DontLinkElementID_12" style="color: rgb(51, 102, 204);"/></dd>
<dt style="clear: both;"><code style="font-family: Courier, Consolas, monospace; color: rgb(102, 102, 102);">NSMergeByPropertyStoreTrumpMergePolicy</code></dt>
<dd>
<p>This policy merges conflicts between the persistent store’s version of the object and the current in-memory version, giving priority to external changes.</p>
<p>The merge occurs by individual property. For properties that have been changed in both the external source and in memory, the external changes trump the in-memory ones.</p>
<p>Available in iOS 3.0 and later.</p>
<p>Declared in <code style="font-family: Courier, Consolas, monospace; color: rgb(102, 102, 102);">NSMergePolicy.h</code>.</p>
</dd>
<dd><a name="//apple_ref/c/data/NSMergeByPropertyObjectTrumpMergePolicy" title="NSMergeByPropertyObjectTrumpMergePolicy" style="color: rgb(51, 102, 204);"/><a name="//apple_ref/doc/c_ref/NSMergeByPropertyObjectTrumpMergePolicy" title="NSMergeByPropertyObjectTrumpMergePolicy" style="color: rgb(51, 102, 204);"/><a name="//apple_ref/doc/uid/TP40010614-CH1-SW27" title="NSMergeByPropertyObjectTrumpMergePolicy" style="color: rgb(51, 102, 204);"/><a name="//apple_ref/doc/uid/TP40010614-CH1-DontLinkElementID_13" style="color: rgb(51, 102, 204);"/></dd>
<dt style="clear: both;"><code style="font-family: Courier, Consolas, monospace; color: rgb(102, 102, 102);">NSMergeByPropertyObjectTrumpMergePolicy</code></dt>
<dd>
<p>This policy merges conflicts between the persistent store’s version of the object and the current in-memory version, giving priority to in-memory changes.</p>
<p>The merge occurs by individual property. For properties that have been changed in both the external source and in memory, the in-memory changes trump the external ones.</p>
<p>Available in iOS 3.0 and later.</p>
<p>Declared in <code style="font-family: Courier, Consolas, monospace; color: rgb(102, 102, 102);">NSMergePolicy.h</code>.</p>
</dd>
<dd><a name="//apple_ref/c/data/NSOverwriteMergePolicy" title="NSOverwriteMergePolicy" style="color: rgb(51, 102, 204);"/><a name="//apple_ref/doc/c_ref/NSOverwriteMergePolicy" title="NSOverwriteMergePolicy" style="color: rgb(51, 102, 204);"/><a name="//apple_ref/doc/uid/TP40010614-CH1-SW28" title="NSOverwriteMergePolicy" style="color: rgb(51, 102, 204);"/><a name="//apple_ref/doc/uid/TP40010614-CH1-DontLinkElementID_14" style="color: rgb(51, 102, 204);"/></dd>
<dt style="clear: both;"><code style="font-family: Courier, Consolas, monospace; color: rgb(102, 102, 102);">NSOverwriteMergePolicy</code></dt>
<dd>
<p>This policy overwrites state in the persistent store for the changed objects in conflict.</p>
<p>Changed objects’ current state is forced upon the persistent store.</p>
<p>Available in iOS 3.0 and later.</p>
<p>Declared in <code style="font-family: Courier, Consolas, monospace; color: rgb(102, 102, 102);">NSMergePolicy.h</code>.</p>
</dd>
<dd><a name="//apple_ref/c/data/NSRollbackMergePolicy" title="NSRollbackMergePolicy" style="color: rgb(51, 102, 204);"/><a name="//apple_ref/doc/c_ref/NSRollbackMergePolicy" title="NSRollbackMergePolicy" style="color: rgb(51, 102, 204);"/><a name="//apple_ref/doc/uid/TP40010614-CH1-SW29" title="NSRollbackMergePolicy" style="color: rgb(51, 102, 204);"/><a name="//apple_ref/doc/uid/TP40010614-CH1-DontLinkElementID_15" style="color: rgb(51, 102, 204);"/></dd>
<dt style="clear: both;"><code style="font-family: Courier, Consolas, monospace; color: rgb(102, 102, 102);">NSRollbackMergePolicy</code></dt>
<dd>
<p>This policy discards in-memory state changes for objects in conflict.</p>
<p>The persistent store’s version of the objects’ state is used.</p>
<p>Available in iOS 3.0 and later.</p>
<p>Declared in <code style="font-family: Courier, Consolas, monospace; color: rgb(102, 102, 102);">NSMergePolicy.h</code>.</p>
</dd>
</dl>
<div style="font-family: 'Lucida Grande', 'Lucida Sans Unicode', Helvetica, Arial, Verdana, sans-serif; font-size: 13px; background-color: rgb(255, 255, 255);">
<h5 style="padding: 0px; font-size: 13px;">Discussion</h5>
<p>The default policy is the <code style="font-family: Courier, Consolas, monospace; color: rgb(102, 102, 102);"><a href="https://developer.apple.com/library/ios/documentation/CoreData/Reference/NSMergePolicy_Class/Reference/%23//apple_ref/doc/c_ref/NSErrorMergePolicy" style="color: rgb(51, 102, 204); text-decoration: none;">NSErrorMergePolicy</a></code>. It is the only policy that requires action to correct any conflicts; the other policies make a save go through silently by making changes following their rules.</p>
</div>
<a name="//apple_ref/c/tdef/NSMergePolicyType" title="NSMergePolicyType" style="color: rgb(51, 102, 204); font-family: 'Lucida Grande', 'Lucida Sans Unicode', Helvetica, Arial, Verdana, sans-serif; font-size: 13px; background-color: rgb(255, 255, 255);"/><a name="//apple_ref/doc/c_ref/NSMergePolicyType" title="NSMergePolicyType" style="color: rgb(51, 102, 204); font-family: 'Lucida Grande', 'Lucida Sans Unicode', Helvetica, Arial, Verdana, sans-serif; font-size: 13px; background-color: rgb(255, 255, 255);"/><a name="//apple_ref/doc/uid/TP40010614-CH1-SW6" title="NSMergePolicyType" style="color: rgb(51, 102, 204); font-family: 'Lucida Grande', 'Lucida Sans Unicode', Helvetica, Arial, Verdana, sans-serif; font-size: 13px; background-color: rgb(255, 255, 255);"/><a name="//apple_ref/doc/uid/TP40010614-CH1-DontLinkElementID_16" style="color: rgb(51, 102, 204); font-family: 'Lucida Grande', 'Lucida Sans Unicode', Helvetica, Arial, Verdana, sans-serif; font-size: 13px; background-color: rgb(255, 255, 255);"/>
<div><br/></div>
</div>
</div>
</body></html>